{% extends "website/base.html" %}
{% load staticfiles %}

{% block style-block %}

{% endblock style-block %}

{% block body_block %}
    {% for tank in tanks %}
        <div id="div_tank_{{tank.pk}}">
            {{tank}}
        <div>
    {% endfor %}
{% endblock %}


{% block sidebar-block %}
    {% with active_menu="dashboard" %}
        {{ block.super }}
    {% endwith %}
{% endblock sidebar-block %}

{% block page-header-block %}
<!-- Page Heading -->
<div id="div_breadcrumb" class="row">
    <div class="col-lg-12">
        <h1 class="page-header">
            Dashboard
            <small>Pinewoods</small>
        </h1>
        <ol class="breadcrumb">
            <li>
                <i class="fa fa-dashboard"></i>  <a href="index.html">Pinewoods</a>
            </li>
            <li class="active">
                <i class="fa fa-file"></i> Dashboard
            </li>
        </ol>
    </div>
</div>
{% endblock page-header-block %}

{% block container-fluid-block %}

<div class="row">
    <div class="col-lg-4">
        <!-- Water Level Graphics -->
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Nível da Caixa</h3>
            </div>
            <div class="panel-body">
                <svg id="fillgauge1" width="97%" height="300"></svg>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Metas de Consumo</h3>
            </div>
            <div class="panel-body">
                <div id="container" style="min-width: 310px; height: 300px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Nível da Caixa</h3>
            </div>
            <div class="panel-body">
                <div id="container2" style="min-width: 310px; height: 150px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
</div>

{% endblock container-fluid-block %}

{% block script-block %}

    <!-- D3.JS -->
    <script src="{% static "website/js/d3.v3.min.js" %}"></script>

    <!-- liquidFillGauge http://bl.ocks.org/brattonc/5e5ce9beee483220e2f6 -->
    <script src="{% static "website/js/liquidFillGauge.js" %}"></script>

    <!-- highcharts.js TODO: download file -->
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/modules/exporting.js"></script>

    <!-- burndownChart.js -->
    <script src="{% static "website/js/burndownChart.js" %}"></script>

    {% for tank in tanks %}
    <!-- Ajax request for {{ tank.description }}-->
    <script language="JavaScript">

        function plot_gauge(data){
            var config = liquidFillGaugeDefaultSettings();
            config.waveAnimateTime = 3500;
            config.waveHeight = 0.05;
            config.waveCount = 2.7;

            // level = Math.floor(Math.random() * 100); // Debug
            level = Math.floor(data.level);

            // TODO: Mult-tank plot support
            var gauge1 = loadLiquidFillGauge("fillgauge1", level, config);
        }

        url_tank_level = "{% url 'current-level' water_tank=tank.pk %}"

        $.ajax({
            dataType: "json",
            url: url_tank_level,
            cache: false,
            success: plot_gauge
        });

    </script>

    <!-- Ajax request for {{ tank.description }}-->
    <script language="JavaScript">

    function plot_burndown(data) {
        step = data.goal / data.days_count;
        goal_array = [Math.floor(data.goal - step)];
        consumed_array = [Math.floor(data.goal - data.consumption[0])];

        for(i=0; i < data.days_count; i++)
            goal_array.push(Math.floor(goal_array[i] - step));

        for(i=0; i < data.consumption.length; i++){
            consumed_array.push(Math.floor(
                consumed_array[i] - data.consumption[i]));
        }
        water_goal_graph(goal_array, consumed_array);
    }

    {% now "Y" as year_ %}{% now "m" as month_ %}
    url_tank_level = "{% url 'monthly-goals' water_tank=tank.pk year=year_ month=month_ %}"

    $.ajax({
        dataType: "json",
        url: url_tank_level,
        cache: false,
        success: plot_burndown
    });

    </script>
    {% endfor %}

    <script language="JavaScript">
        $(function () {
            $('#container2').highcharts({
                credits: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                chart: {
                    type: 'area'
                },
                title: {
                    text: ''
                },
                xAxis: {
                    allowDecimals: false,
                    labels: {
                        formatter: function () {
                            return this.value; // clean, unformatted number for year
                        }
                    }
                },
                yAxis: {
                    title: {
                        text: 'Nível da Caixa em (%)'
                    },
                    labels: {
                        formatter: function () {
                            return this.value + '%';
                        }
                    }
                },
                tooltip: {
                    pointFormat: '{series.name} produced <b>{point.y:,.0f}</b><br/>warheads in {point.x}'
                },
                plotOptions: {
                    area: {
                        pointStart: 1940,
                        marker: {
                            enabled: false,
                            symbol: 'circle',
                            radius: 2,
                            states: {
                                hover: {
                                    enabled: true
                                }
                            }
                        }
                    }
                },
                series: [{
                    name: 'Nível',
                    showInLegend: false,
                    data: [75, 78, 76, 80, 84, 86, 91, 92, 100, 93.5, 96.9, 94.0,
                        90.05, 94.36, 90.63, 90.57, 96.18, 94.44, 98.22, 84.126, 70.434, 65.468,  
                        57.387, 39.459, 21.056, 31.982, 32.040, 31.233, 29.224, 27.342, 26.662,
                        26.956, 27.912, 28.999, 28.965, 27.826, 25.579, 25.722, 24.826, 24.605,
                        24.304, 23.464, 23.708, 24.099, 24.357, 24.237, 24.401, 24.344, 23.586,
                        22.380, 21.004, 17.287, 14.747, 13.076, 12.555, 12.144, 11.009, 10.950,
                        10.871, 10.824, 10.577, 15.527, 20.475, 25.421, 30.358, 40.295, 52.104]
                }]
            });
        });
    </script>

{% endblock script-block %}
